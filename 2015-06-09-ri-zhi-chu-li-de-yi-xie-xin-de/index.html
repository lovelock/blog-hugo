<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>  &middot; Me and the Web</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="  &middot; Me and the Web ">
<meta property="og:site_name" content="Me and the Web"/>
<meta property="og:url" content="http://unixera.com/2015-06-09-ri-zhi-chu-li-de-yi-xie-xin-de/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="0001-01-01T00:00:00Z" />
<meta property="og:article:modified_time" content="0001-01-01T00:00:00Z" />

  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@frostwong" />
<meta name="twitter:creator" content="@frostwong" />
<meta name="twitter:title" content="" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="http://unixera.com/2015-06-09-ri-zhi-chu-li-de-yi-xie-xin-de/" />
<meta name="twitter:domain" content="http://unixera.com">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "0001-01-01",
    "description": "",
    "wordCount":  65 
  }
</script>



<link rel="canonical" href="http://unixera.com/2015-06-09-ri-zhi-chu-li-de-yi-xie-xin-de/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://unixera.com/touch-icon-144-precomposed.png">
<link href="http://unixera.com/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://unixera.com/css/font-awesome.min.css">
<link rel="stylesheet" href="http://unixera.com/css/style.css">
<link rel="stylesheet" href="http://unixera.com/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://unixera.com">
  Frost Wong

</a>

</div>

  
<div class="container topline">
  
  Be a better WEB developer


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="http://unixera.com/about">About</a>

<a href="http://unixera.com/post" title="Show list of posts">Posts</a>

<a href="http://unixera.com/tags" title="Show list of tags">Tags</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:frostwong@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/lovelock">
  <span class="fa fa-github-square"></span><span>github</span></a>











<a id="contact-link-twitter" class="contact_link" href="https://twitter.com/frostwong">
  <span class="fa fa-twitter-square"></span><span>twitter</span></a>







</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>
</h1>

</header>

  <div class="container content">
  <p>title  = &ldquo;日志处理的一些心得&rdquo;
date = &ldquo;2015-06-09T19:32:40+08:00&rdquo;
+++</p>

<p>今天花了很长时间处理日志，然而并没有什么卵用。</p>

<p>发给我的日志是个压缩包，127M，解压后大概是430多M，在我之前的工作生涯中是没有见过那么大的日志的，果然在小公司待的时间长了是完全体会不到大公司的量级了。</p>

<p>言归正传，说说问题本身。</p>

<ol>
<li>日志有6天的纪录，4列数据，一定是我前面已经有人筛选过了，不过ta画蛇添足的把这几天的日志merge到一起了，我还得再给他拆分。</li>
<li>第一列是日期，第二列是来源，第三列是重点，是object_id，需要拿这个id作为HTTP请求的参数，然后根据返回的结果求和第四列的值。</li>
</ol>

<p>条件是这样的：
需要调用的接口是可以接受批处理请求的，而且一次接受的id数量不能超过100个。</p>

<p>因此，我起初最简单的想法就是</p>

<ol>
<li>只要文件还没有结束，就顺序读取文件的每一行，当读取的行数是100的倍数时，就把这最近的100个id组合成一个参数值传到请求的url参数表中</li>
<li>从返回的结果中查找想要的字段</li>
<li>根据该字段的值对第四列的次数做求和</li>
</ol>

<p>本身是直观的一个想法，但实际上实施起来就没那么简单了，对，就是内存溢出。</p>

<p>看到这个结果首先想到的就是拆分文件，但实际上我按天拆分了之后完全起不到作用，日志总共有700多万条，而即使按天拆分每天也是有100多万条，这100多万条本身并不大，但如果算上每100条就要请求发一次HTTP请求，而且要根据返回值进行一系列的判断的话，内存就吃紧了，要知道我不是在那仅仅有1G内存的公司开发用的服务器上跑的程序，而是在我新买的16G内存的rMBP 15&rsquo;上跑的！</p>

<p>所以就还需要想办法，我就想到了之前的公司经常用的<code>shell_exec</code> 打法，但整理了一下思路之后发现这个方法的实施难度也是挺高的，因为这并不是数据库操作，如果是数据库的话，可以给要执行的worker <sup class="footnote-ref" id="fnref:30539fa7002fe031eb207b07f6f3e528:worker"><a rel="footnote" href="#fn:30539fa7002fe031eb207b07f6f3e528:worker">1</a></sup> 部分的代码传入一个<code>limit</code> ，然后它就根据这个值自动的查询到你要的结果，但这里不是，一旦你读入了这个文件，就要一直读下去，中途如果<code>close</code>掉了，就再也不知道上一次运行到哪里了，那能它传入什么呢？传入HTTP请求的返回值？如果这个HTTP请求都已经放在invoker里面了，那其实worker就没有存在的必要了。无论如何我也想不出这个方案的可行度，后来放弃了。</p>

<p>然后呢，需求方那边要得急，我也来不及多想，只能想着把文件再切分，直接上了<code>split</code>方法，把文件切分成每10万行一个的小文件，为了加快速度，把文件作为参数传入脚本，开很多个终端同时跑，出来的结果是多行，但列数是固定的，这时就可以用awk把最终的结果搞出来</p>

<pre><code class="language-sh">split -l 100000 all.log stat_
</code></pre>

<p>简单说一下split的用法，<code>-l</code>指定每个文件的大小，比如这个文件一共750000行，那你每10万行分成一个文件，前7个文件都是100000行，最后一个当然就只有50000万行。
最后一个参数是生成的文件的前缀，比如执行完这条命令后会在当前目录里生成若干个<code>stat_aa</code>之类的文件。这是默认的情况，其实是可以指定用来区分每个文件的后缀的长度的，它是这个命令的第一个参数，不可以放在最后，<code>-a 4</code>，在<code>split</code>后紧跟这个命令得到的文件名就形如<code>stat_aaaa</code>这样的了。</p>

<pre><code class="language-sh">awk -F'|' 'BEGIN{sum=0}{sum+=$1}END{print sum}' $1
echo '|'
</code></pre>

<p>上面这行是第一列的和，多写几遍就得到了类似
<code>x1 | x2 | x3 | ..</code>的一行数据，直接粘在markdown编辑器里就能得到他们要得表格了。</p>

<p>虽然这个方法土的掉渣，朴素的掉渣，但在短时间内确实解决了问题，也不枉我这一下午的时间。但我心里还是觉得难受，这样的工作其实是没有什么意义的，解决这种大数据量的问题，让计算机自己去分片然后处理才是王道，这样的做法虽然是解决了问题，但问题其实是仍然存在的。</p>

<p>下面多想一点，能不能把我自己手工做的工作让计算机自己去做呢？</p>

<ol>
<li>分片，已经确定了分成10万行的单个文件处理起来是没有问题的</li>
<li>把文件作为参数传入脚本，这就牵涉到一个for循环</li>
</ol>

<p>脚本的执行流程就可以是这样</p>

<ol>
<li>先分片</li>
<li>在invoker中组织<code>stat_aaaa</code>这样的文件名，把文件传入用<code>shell_exec</code>调用的命令中作为参数，命令直接输出到标准输出，或者复杂一点可以写入文件，其实是写入文件更方便操作。</li>
<li>在worker中执行完之后<code>exit</code>，内存释放，重新回到invoker</li>
<li>invoker把下一个文件名传给worker，重复3，直至所有文件遍历完毕。</li>
</ol>

<p>明天可以抽时间实践一下这个想法。</p>

<p>2015年6月10日更新：
今天尝试了一下昨天想到的方案，果然好用，再加一点，把每个worker的输出结果重定向到一个结果文件中，最终就可以直接出来结果文件了，很简单了。我真是太有才了。</p>

<p>不过这其实也不是一个优雅的方案，这仅仅是用了PHP内建的cURL功能来完成网络请求，主要用的还是UNIX得那一套工具链，并没有把工具很好的集成。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:30539fa7002fe031eb207b07f6f3e528:worker">和invoker都是我自己的说法，其中invoker指的是入口脚本，在它里面做数据分片的工作，实际的工作在worker中完成，然后退出，控制权回到invoker继续调用下一次worker，达到每做完一个worker的工作，其占用的内存就释放掉的效果。
 <a class="footnote-return" href="#fnref:30539fa7002fe031eb207b07f6f3e528:worker"><sup>[return]</sup></a></li>
</ol>
</div>

</div>


  
</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  
<a href="http://unixera.com/license">license</a>


  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  Learn what you eager


</div>


  
<div class="container copyright">
  
  &copy; 2013-2015 Frost Wong. All rights reserved.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//unixagain.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="http://unixera.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

