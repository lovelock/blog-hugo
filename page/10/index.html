<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Me and the Web </title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="Me and the Web ">
<meta property="og:site_name" content="Me and the Web"/>
<meta property="og:url" content="http://lovelock.github.io/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="website" />



<link href="http://lovelock.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Me and the Web" />

<link rel="canonical" href="http://lovelock.github.io/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://lovelock.github.io/touch-icon-144-precomposed.png">
<link href="http://lovelock.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://lovelock.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="http://lovelock.github.io/css/style.css">
<link rel="stylesheet" href="http://lovelock.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://lovelock.github.io">
  Frost Wong

</a>

</div>

  
<div class="container topline">
  
  Be a better WEB developer


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="http://lovelock.github.io/php" title="Show list of posts">PHP</a>

<a href="http://lovelock.github.io/python" title="Python stuff">Python</a>

<a href="http://lovelock.github.io/about">About</a>

<a href="http://lovelock.github.io/post" title="Show list of posts">Posts</a>

<a href="http://lovelock.github.io/tags" title="Show list of tags">Tags</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:frostwong@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/lovelock">
  <span class="fa fa-github-square"></span><span>github</span></a>











<a id="contact-link-twitter" class="contact_link" href="https://twitter.com/frostwong">
  <span class="fa fa-twitter-square"></span><span>twitter</span></a>







</div>


  

</header>


<section id="main-content" class="container main_content homepage">
  <header class="container header">
    <h1>Me and the Web
</h1>

    <span>last update: <time datetime="2016-01-10T13:19:42&#43;08:00">10 January at 1:19pm</time>
</span>

  </header>
  
  
    <article class="container content summary">
  <div class="container hat">
  <h2><a href="http://lovelock.github.io/1/01/01/">
</a>
</h2>

  <time datetime="0001-01-01">1 Jan, 0001</time>

</div>

  <p class="container content">
  
  
    title = &ldquo;关于smcFanControl的一点感想&rdquo; date = &ldquo;2015-06-06T15:39:24+08:00&rdquo; +++ 前天晚上看了池建强先生的《MacTalk：人生元编程》，其中提到了很多关于Mac和OS X的东西，其中一点引起了我的注意，那就是关于夏天电脑发热严重，怎样避免呢？那么作者就提到了smcFanControl。 由于我是首次用Mac OS X，不太懂什么是smc等等，抱着好奇的心情就找来安装了，装上后很惊喜的发现它会让你手动调节风扇的转速——然而这个好奇没有坚持一分钟我就意识到这个软件不能用——因为它会让操作系统无法按需调节风扇的转速。也就是说，它通过修改底层的系统参数把风扇的控制由自动模式切换到了手动模式。 这个问题就很难搞了。 当然我看到这个问题的时候第一反应肯定是上网去寻找答案，然而发现的大多数言论都是在批评这个软件的，说它永久性的修改了底层的参数，只能通过用BootCamp安装一个Windows，然后在Windows里安装一个Everest云云的东西修改了这个参数才能好等等的说法。 在我看来，这些想法根本就是阴谋论，它们不知道，软件的作者写这个免费软件的初衷肯定是解决自己的问题，如果它把一个问题解决成这个样子，那么这个软件肯定不会有那么高的知名度，相信池建强先生也不会在书中推荐。 smc的原理我不太懂，但大概可以理解成是和Linux的内核参数类似的东西吧，就我的知识来看，例如要修改系统打开的最大文件数，那么可以给它传一个参数过去，立即生效，但重启系统之后就失效了，解决方案就是把这个配置写死在一个配置文件中。回到smcFanControl上来，作者已经在网站上声明了这个实现方式，也就是传参数给内核，直接决定风扇的转速。 我想那些说这个软件修改了参数等等言论的人，可能是把这个软件设置成了开机启动，然后每次开机时风扇都会变成手动模式，而这时他们很气愤，于是就把软件卸载了，然后就找各种办法消除这个影响，于是人云亦云，把这个作者说成了阴谋家。 由这件事我想到了单纯的程序员们，我们写某个软件最初肯定是为了解决问题，不管最终你拿到的版本针对你的情况解决问题的程度如何，千万不要马上就怀疑作者的动机，因为没有人会费那么大的力气去故意做一个让人生气的软件，遇到问题的时候如果找不到现成的解决方案，那最好的方式就是联系作者，让他帮你解决，当然你也不用指望这个，因为谁也没有义务免费帮你解决问题。但如果你经常混开源社区就会知道，这些程序员书呆子们其实是恨单纯的，他们把自己的作品看做孩子一样，如果你能有针对性的提出问题，他们通常都会很热情的帮你解决的。看看Github的火爆情况就知道了。
  


</p>


  <div class="container readlink">
  <a href="http://lovelock.github.io/1/01/01/">Read more &rarr;</a>

</div>


</article>

  
    <article class="container content summary">
  <div class="container hat">
  <h2><a href="http://lovelock.github.io/1/01/01/">
</a>
</h2>

  <time datetime="0001-01-01">1 Jan, 0001</time>

</div>

  <p class="container content">
  
  
    title = &ldquo;日志处理的一些心得&rdquo; date = &ldquo;2015-06-09T19:32:40+08:00&rdquo; +++ 今天花了很长时间处理日志，然而并没有什么卵用。 发给我的日志是个压缩包，127M，解压后大概是430多M，在我之前的工作生涯中是没有见过那么大的日志的，果然在小公司待的时间长了是完全体会不到大公司的量级了。 言归正传，说说问题本身。 日志有6天的纪录，4列数据，一定是我前面已经有人筛选过了，不过ta画蛇添足的把这几天的日志merge到一起了，我还得再给他拆分。 第一列是日期，第二列是来源，第三列是重点，是object_id，需要拿这个id作为HTTP请求的参数，然后根据返回的结果求和第四列的值。 条件是这样的： 需要调用的接口是可以接受批处理请求的，而且一次接受的id数量不能超过100个。 因此，我起初最简单的想法就是 只要文件还没有结束，就顺序读取文件的每一行，当读取的行数是100的倍数时，就把这最近的100个id组合成一个参数值传到请求的url参数表中 从返回的结果中查找想要的字段 根据该字段的值对第四列的次数做求和 本身是直观的一个想法，但实际上实施起来就没那么简单了，对，就是内存溢出。 看到这个结果首先想到的就是拆分文件，但实际上我按天拆分了之后完全起不到作用，日志总共有700多万条，而即使按天拆分每天也是有100多万条，这100多万条本身并不大，但如果算上每100条就要请求发一次HTTP请求，而且要根据返回值进行一系列的判断的话，内存就吃紧了，要知道我不是在那仅仅有1G内存的公司开发用的服务器上跑的程序，而是在我新买的16G内存的rMBP 15&rsquo;上跑的！ 所以就还需要想办法，我就想到了之前的公司经常用的shell_exec 打法，但整理了一下思路之后发现这个方法的实施难度也是挺高的，因为这并不是数据库操作，如果是数据库的话，可以给要执行的worker 1 部分的代码传入一个limit ，然后它就根据这个值自动的查询到你要的结果，但这里不是，一旦你读入了这个文件，就要一直读下去，中途如果close掉了，就再也不知道上一次运行到哪里了，那能它传入什么呢？传入HTTP请求的返回值？如果这个HTTP请求都已经放在invoker里面了，那其实worker就没有存在的必要了。无论如何我也想不出这个方案的可行度，后来放弃了。 然后呢，需求方那边要得急，我也来不及多想，只能想着把文件再切分，直接上了split方法，把文件切分成每10万行一个的小文件，为了加快速度，把文件作为参数传入脚本，开很多个终端同时跑，出来的结果是多行，但列数是固定的，这时就可以用awk把最终的结果搞出来 split -l 100000 all.log stat_ 简单说一下split的用法，-l指定每个文件的大小，比如这个文件一共750000行，那你每10万行分成一个文件，前7个文件都是100000行，最后一个当然就只有50000万行。 最后一个参数是生成的文件的前缀，比如执行完这条命令后会在当前目录里生成若干个stat_aa之类的文件。这是默认的情况，其实是可以指定用来区分每个文件的后缀的长度的，它是这个命令的第一个参数，不可以放在最后，-a 4，在split后紧跟这个命令得到的文件名就形如stat_aaaa这样的了。 awk -F'|' 'BEGIN{sum=0}{sum+=$1}END{print sum}' $1 echo '|' 上面这行是第一列的和，多写几遍就得到了类似 x1 | x2 | x3 | ..的一行数据，直接粘在markdown编辑器里就能得到他们要得表格了。 虽然这个方法土的掉渣，朴素的掉渣，但在短时间内确实解决了问题，也不枉我这一下午的时间。但我心里还是觉得难受，这样的工作其实是没有什么意义的，解决这种大数据量的问题，让计算机自己去分片然后处理才是王道，这样的做法虽然是解决了问题，但问题其实是仍然存在的。 下面多想一点，能不能把我自己手工做的工作让计算机自己去做呢？ 分片，已经确定了分成10万行的单个文件处理起来是没有问题的 把文件作为参数传入脚本，这就牵涉到一个for循环 脚本的执行流程就可以是这样 先分片 在invoker中组织stat_aaaa这样的文件名，把文件传入用shell_exec调用的命令中作为参数，命令直接输出到标准输出，或者复杂一点可以写入文件，其实是写入文件更方便操作。 在worker中执行完之后exit，内存释放，重新回到invoker invoker把下一个文件名传给worker，重复3，直至所有文件遍历完毕。 明天可以抽时间实践一下这个想法。 2015年6月10日更新： 今天尝试了一下昨天想到的方案，果然好用，再加一点，把每个worker的输出结果重定向到一个结果文件中，最终就可以直接出来结果文件了，很简单了。我真是太有才了。 不过这其实也不是一个优雅的方案，这仅仅是用了PHP内建的cURL功能来完成网络请求，主要用的还是UNIX得那一套工具链，并没有把工具很好的集成。 和invoker都是我自己的说法，其中invoker指的是入口脚本，在它里面做数据分片的工作，实际的工作在worker中完成，然后退出，控制权回到invoker继续调用下一次worker，达到每做完一个worker的工作，其占用的内存就释放掉的效果。 [return]
  


</p>


  <div class="container readlink">
  <a href="http://lovelock.github.io/1/01/01/">Read more &rarr;</a>

</div>


</article>

  
    <article class="container content summary">
  <div class="container hat">
  <h2><a href="http://lovelock.github.io/1/01/01/">
</a>
</h2>

  <time datetime="0001-01-01">1 Jan, 0001</time>

</div>

  <p class="container content">
  
  
    title = &ldquo;一位老人在地铁上摔倒想到的&rdquo; date = &ldquo;2015-06-12T10:29:55+08:00&rdquo; +++ 今天地铁上还是像往常一样那么多人，我终于在站了近半小时之后有了一个座位。 不知道何时在我左边的左边出现了一位白发苍苍，大概60多岁的老太太。我注意到她还是因为我邻座的那个哥们儿要主动给她让座儿，但是她并没有接受，解释说她自己两站就下车了，没关系的，还不忘谢谢那个年轻人，说话的语气不卑不亢，很有电视上那些老一辈的文化人的风度。 过了一站，她开始往门口走去，这时车上人没有那么拥挤了，在她刚以为自己站稳的时候，车启动了，她就很自然的倒了下去，幸好前面有人拉了一把，她身后的人也拖了一下，她并没有重重的摔下去。站起身后她又站在那个位置，重新开始等待下一站。 我想，这才是真正的和谐社会。老人不会倚老卖老，而年轻人其实更希望能多见到这样的老人，他们是值得尊敬的人，不像有些上车就问年轻人索要座位的“老人”。 我甚至遇到过有一群年纪看起来在50左右的“老人”一进地铁就开始“互相”的说话，说现在的年轻人如何如何，不给他们这些老年人让座儿，这时旁边一位年纪差不多的中年人，他说“你们也不看看自己这么年轻，还好意思说自己是老年人！”这时，这几个“老年人”就不乐意了，怒斥道“那你说说你多大了，你要是比我们大，那我们就把作为让给你！”果然有年轻人听不下去了，就给那个“老年妇女”让了个座儿，我估计是她自己面子上也挂不住了，刚坐下一会儿就把座位又让给了一个带孩子的母亲。 没有任何人应该为一个陌生人做任何事，人家做了，是他的好心，但要记住，那不是人家的义务，你也不用拿自己的弱势做理由来道德绑架别人，这样做只会惹来别人的反感。
  


</p>


  <div class="container readlink">
  <a href="http://lovelock.github.io/1/01/01/">Read more &rarr;</a>

</div>


</article>

  
  
<div class="container pagination">
  


<a aria-label="First" href="http://lovelock.github.io/">
  <span aria-hidden="true">««</span>
</a>

<a aria-label="Previous" href="http://lovelock.github.io/page/9/">
  <span aria-hidden="true">«</span>
</a>


<a href="http://lovelock.github.io/">
  1
</a>

<a href="http://lovelock.github.io/page/2/">
  2
</a>

<a href="http://lovelock.github.io/page/3/">
  3
</a>

<a href="http://lovelock.github.io/page/4/">
  4
</a>

<a href="http://lovelock.github.io/page/5/">
  5
</a>

<a href="http://lovelock.github.io/page/6/">
  6
</a>

<a href="http://lovelock.github.io/page/7/">
  7
</a>

<a href="http://lovelock.github.io/page/8/">
  8
</a>

<a href="http://lovelock.github.io/page/9/">
  9
</a>

<a class="active" href="http://lovelock.github.io/page/10/">
  10
</a>


<a class="disabled" aria-label="Next" href="#">
  <span aria-hidden="true">»</span>
</a>

<a aria-label="Last" href="http://lovelock.github.io/page/10/">
  <span aria-hidden="true">»»</span>
</a>


</div>


</section>

      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  
<a href="http://lovelock.github.io/license">license</a>


  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  Learn what you eager


</div>


  
<div class="container copyright">
  
  &copy; 2013-2015 Frost Wong. All rights reserved.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//unixagain.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="http://lovelock.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

