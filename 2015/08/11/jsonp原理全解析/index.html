<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>jsonp原理全解析  &middot; Me and the Web</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="jsonp原理全解析  &middot; Me and the Web ">
<meta property="og:site_name" content="Me and the Web"/>
<meta property="og:url" content="http://lovelock.github.io/2015/08/11/jsonp%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" />
<meta property="og:locale" content="en-us">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2015-08-11T23:40:32Z" />
<meta property="og:article:modified_time" content="2015-08-11T23:40:32Z" />

  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@frostwong" />
<meta name="twitter:creator" content="@frostwong" />
<meta name="twitter:title" content="jsonp原理全解析" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="http://lovelock.github.io/2015/08/11/jsonp%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" />
<meta name="twitter:domain" content="http://lovelock.github.io">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "jsonp原理全解析",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2015-08-11",
    "description": "",
    "wordCount":  136 
  }
</script>



<link rel="canonical" href="http://lovelock.github.io/2015/08/11/jsonp%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://lovelock.github.io/touch-icon-144-precomposed.png">
<link href="http://lovelock.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://lovelock.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="http://lovelock.github.io/css/style.css">
<link rel="stylesheet" href="http://lovelock.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="http://lovelock.github.io">
  Frost Wong

</a>

</div>

  
<div class="container topline">
  
  Be a better WEB developer


</div>


</div>

  <nav class="container nav primary no-print">
  


  
<a href="http://lovelock.github.io/php" title="Show list of posts">PHP</a>

<a href="http://lovelock.github.io/python" title="Python stuff">Python</a>

<a href="http://lovelock.github.io/about">About</a>

<a href="http://lovelock.github.io/post" title="Show list of posts">Posts</a>

<a href="http://lovelock.github.io/tags" title="Show list of tags">Tags</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:frostwong@gmail.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/lovelock">
  <span class="fa fa-github-square"></span><span>github</span></a>











<a id="contact-link-twitter" class="contact_link" href="https://twitter.com/frostwong">
  <span class="fa fa-twitter-square"></span><span>twitter</span></a>







</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>jsonp原理全解析
</h1>

  <div class="metas">
<time datetime="2015-08-11">11 Aug, 2015</time>


  
  &middot; Read in about 1 min
  &middot; (136 字)
  <br>
  


</div>

</header>

  <div class="container content">
  

<p>昨天写了一篇关于iframe间跨域通讯问题的总结，想着既然提到了jsonp这个长久以来曽令我困惑的技术，就再总结一篇吧。</p>

<p>主要参考了<a href="http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html" target="_blank">这篇文章</a>。</p>

<h2 id="起因:24279198b24a374a578386a387b89bea">起因</h2>

<p>jsonp是为了解决跨域请求而产生的技术，这里的跨域并不是iframe之间通讯的那种，后者是禁止了一个域的js操作位于另一个域的资源，往往是为了在iframe之间传递变量，而jsonp则是为了解决跨域请求接口。但说到底，还是同源策略引起的。</p>

<h2 id="原理:24279198b24a374a578386a387b89bea">原理</h2>

<p>jsonp的出现是优秀的工程师智慧的结晶。可能是受到“所有带src属性的标签都可以跨域访问资源”这个事实的启发。设想一下，诸如<code>&lt;script&gt;/&lt;img&gt;/&lt;iframe</code>这些标签，它们请求后返回的是脚本或者图片或者页面，那么能不能返回一个函数调用呢？当然能。</p>

<p>如，在本地的页面上定义一个函数<code>function_example</code></p>

<pre><code class="language-html">&lt;script&gt;
    function function_example() {
        alert(&quot;我是本地定义的函数&quot;);
    }
&lt;/script&gt;
&lt;script src=&quot;http://remotehost.com/remote.js&quot;/&gt;&lt;/script&gt;
</code></pre>

<p>《JavaScript高级程序设计》第一章提到了脚本加载是按照顺序执行的，也就是说在加载remote.js时，前面定义<code>function_example</code>的脚本已经加载了，即该函数已经定义了。那么如果在remote.js中调用该函数，会出现什么情况呢？当然函数就被执行了。</p>

<pre><code class="language-javascript">function_example();
</code></pre>

<p>上面就是jsonp实现的基础原理。</p>

<h2 id="实践:24279198b24a374a578386a387b89bea">实践</h2>

<p>那么具体到使用应该怎么操作呢？
不要看到在第一个例子中引入了remote.js文件就误以为我们真的是要引入js文件了，要记得我们的目的是请求服务接口，所以，服务端应该返回类似<code>function_example()</code>这样的形式才可以，也即需要返回一个由函数名包含的结果，括号中才是真正的结果，那么结果当然要用JavaScript原生支持的json格式才完美了。所以我们看到的jsonp的返回值多数形如<code>callback({&quot;aa&quot;: &quot;bb&quot;, &quot;cc&quot;: &quot;dd&quot;})</code>。</p>

<p>前端</p>

<pre><code class="language-html">&lt;script&gt;
    function handler(result) {
        alert(result.login);
    }
    
    var url = &quot;http://remotehost.com/index.php?name=frost&amp;pass=123&amp;callback=handler&quot;;
    var script = document.createElement(&quot;script&quot;);
    script.setAttribute(&quot;src&quot;, url);
    document.getElementsByTagName(&quot;head&quot;)[0].appendChild(script);
&lt;/script&gt;
</code></pre>

<p>那服务端应该怎么处理呢？</p>

<pre><code class="language-php">&lt;?php

$name = $_GET['name'];
$pass = $_GET['pass'];
$callback = $_GET['callback'];
// do something

$result = [
    &quot;login&quot;: &quot;true&quot;,
    &quot;other&quot;: &quot;foobar&quot;
];

echo json_encode($result);
</code></pre>

<p>上面的代码能完成要求吗？显然不能，因为它返回的是一个json对象，而不是能够执行的js指令。
因此，最后一句应该写成</p>

<pre><code class="language-php">echo $callback . '(' . $result . ')';
</code></pre>

<p>这样就完整了。</p>

<p>这还引出了另外一个安全问题，既然请求可以返回函数调用的代码片段，那么也可以返回任意的代码片段，如果直接<code>eval</code>执行返回的代码片段就会带来安全隐患，因为你不知道服务器返回的是什么样的调用。</p>

<h2 id="应用场景:24279198b24a374a578386a387b89bea">应用场景</h2>

<p>实际使用中就像AJAX一样，虽然用原生的方法也可以写，但毕竟不那么方便，最流行的当然是jQuery了，提供了方便的jsonp支持，就像发送普通的ajax请求一样。</p>

<pre><code class="language-javascript">$.ajax({
    data: params,
    url: url,
    dataType: &quot;jsonp&quot;,
    jsonp: &quot;callback&quot;,
    jsonpCallback: &quot;function_name&quot;,
    success: function (response) {
        alert(response.result);
    },
    error: function () {
        // other handle
    }
});
</code></pre>

<p>事实上我们不用关心回调函数的名称，因为不管是什么，只要能传递到服务端，两端保持一致就可以保证正常执行。因此，在上面的请求中<code>jsonp/jsonpCallback</code>参数不是必需的。</p>

<h2 id="完整示例:24279198b24a374a578386a387b89bea">完整示例</h2>

<p>看完上面的代码片段有同学可能要问了，那如果客户端不用jsonp的方式调用服务呢？这样返回的结果岂不是错了。对，所以还要做一下适配，就像我们通常会给PHP的超全局变量封装一层获取参数的方法一样，也会给返回前对结果处理的方法做一些统一。</p>

<pre><code class="language-php">
echo preResult(json_encode($result));

function preResult($encodedResult) {
    $callback = $_GET['callback'];
    $postResult = $callback ? $callback . &quot;(&quot; . $result . &quot;)&quot; : $result;
    
    return $postResult;
}
</code></pre>

<p>注意，上面的代码片段没有做必要的条件判断和异常捕获等操作，生产环境代码中要视具体情况而定。</p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="http://lovelock.github.io/2015/08/10/iframe%E9%97%B4%E9%80%9A%E4%BF%A1%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/" title="iframe间通信方法总结">
      上一篇
    </a>
    

    
    <a class="next" href="http://lovelock.github.io/2015/08/12/rime%E8%BE%93%E5%85%A5%E6%B3%95%E5%9C%A8mac%E4%B8%8A%E7%9A%84%E5%BA%94%E7%94%A8/" title="Rime输入法在Mac上的应用">
      下一篇
    </a>
    

  


</div>

  <div class="container comments">
  <h2>评论</h2>
  
<div class="ds-thread" data-thread-key="" data-title="jsonp原理全解析" data-url="http://lovelock.github.io/2015/08/11/jsonp%E5%8E%9F%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90/"></div>



<script type="text/javascript">
    var duoshuoQuery = {short_name:"UnixAgain"};

    (function() {
     var ds = document.createElement('script');
     ds.type = 'text/javascript';ds.async = true;
     ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
     ds.charset = 'UTF-8';
     (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
     })();
    </script>


</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  
<a href="http://lovelock.github.io/license">license</a>


  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  Learn what you eager


</div>


  
<div class="container copyright">
  
  &copy; 2013-2015 Frost Wong. All rights reserved.


</div>


</div>

</footer>

    </main>
    


<script src="http://lovelock.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

